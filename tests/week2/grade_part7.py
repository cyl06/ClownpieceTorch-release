"""
Unfold
"""
import torch
from graderlib import set_debug_mode, testcase, grader_summary, print_separate_line

test_data_images = [
  [
    [[1.0, 2.0, 3.0], [4.0, 5.0, 6.0], [7.0, 8.0, 9.0]],
    [[10.0, 11.0, 12.0], [13.0, 14.0, 15.0], [16.0, 17.0, 18.0]]
  ]
]

@testcase(name="unfold", score=10000)
def unfold(impl = torch):  
  a = impl.Tensor(test_data_images)
  a.requires_grad_()
  
  if impl.__name__ == "torch":
    unfold = impl.nn.Unfold(kernel_size=(2, 3))
    b = unfold(a)
  else:
    b = a.unfold([2, 3])
  
  b.backward(impl.ones_like(b))
  
  c = impl.Tensor(test_data_images)
  c.requires_grad_()
  
  if impl.__name__ == "torch":
    unfold = impl.nn.Unfold(kernel_size=3)
    d = unfold(c)
  else:
    d = c.unfold(3)
  
  d.backward(impl.ones_like(d))
  return b, a.grad, d, c.grad

@testcase(name="unfold_hard", score=10000)
def unfold_hard(impl = torch):
  inp = impl.Tensor(
    [[[[-0.286037, 1.72707, 0.148865, -0.815275, -0.565091, 0.426917, 0.84797, 0.17942, 1.19711, -0.792038, 0.837364, 0.470338],
       [-1.7982, 1.44509, 0.839922, -0.859145, -0.0847108, 0.386881, -0.966639, -0.822292, -1.08421, 1.35075, -0.629903, 1.08006],
       [-0.177281, -1.19753, 1.36712, -0.338066, -0.746437, -1.20701, 1.18601, 1.32596, -1.51811, 0.21528, 0.600178, 0.41297],
       [-0.574095, -0.517079, -0.533353, 0.540503, 0.374637, 0.571759, 0.422618, -0.355232, 1.22395, 0.341918, -0.364556, 0.256093],
       [-0.705757, -0.43843, -2.98578, -0.898131, -0.57132, -0.0346407, -0.662507, 1.09098, -0.362309, 0.388757, 0.479558, 1.21192],
       [-0.246572, -1.93836, -0.941842, 0.0370184, -1.90789, -0.447897, -0.877872, 1.40368, 0.829966, 2.14947, -1.93836, -1.82019],
       [-0.485932, 0.157139, 0.900326, 0.365648, -1.94575, 0.883235, -1.06928, -2.23627, -2.51589, -0.333307, -0.08717, -0.813047],
       [-0.213776, 0.0703384, -1.58747, -0.772815, -0.37345, 1.67586, 1.60286, -0.168062, 0.531119, -0.353585, -0.72468, 0.050768],
       [1.01134, 0.812058, -0.598273, -1.49885, 1.551, 0.654533, -0.244511, -0.968828, 2.23273, 1.48434, 1.71972, -0.271765],
       [0.670871, 0.324567, -1.70049, 0.0722455, -1.38397, -0.53671, 1.29419, 0.816536, 0.923433, -0.699048, 0.572073, -1.12676]],
      [[-1.99076, -0.112561, -0.76534, -1.48024, 0.82322, -0.176448, -0.78936, 0.34312, -0.499689, -0.337862, 0.973641, -1.63302],
       [0.77526, -0.425459, 0.681514, -1.71096, 0.633127, 2.67092, 0.258782, 0.0921672, 0.270304, -0.113938, 0.51922, 0.888604],
       [1.03026, 0.970353, -0.0573979, 1.54375, -0.119342, 0.651219, 1.93175, -0.967824, 2.11631, -0.415473, -0.717701, -2.28255],
       [0.739365, 0.570817, -0.3761, 0.0355637, -1.4675, 0.000251759, -1.42321, 0.764582, -0.0190878, -1.64223, 0.332421, 0.122952],
       [-0.036089, 1.1132, -1.64198, 0.0474308, -0.146167, 0.695031, -0.0947421, -2.8618, -1.95585, 0.730116, 1.02425, 0.697331],
       [-0.400265, 0.879372, 2.32354, -0.960128, 1.51957, 0.65209, -0.254694, -1.4003, -0.477601, 0.0385565, -0.400535, -1.66633],
       [0.665539, 0.668196, -0.550766, -0.919727, 0.150586, -0.646339, 0.0942068, -0.424139, -1.25207, -1.43808, 0.121221, 2.2762],
       [0.569256, -1.66281, 0.597532, -0.662731, 0.45551, -0.549927, -0.787113, -0.0252289, -0.428791, -0.109747, -0.171997, -1.53181],
       [-1.55564, -0.585022, -0.671553, -1.55785, 0.237799, 3.14959, -1.05757, 1.13073, 0.13826, -1.03818, 0.789355, -0.189301],
       [1.25868, 1.44971, 0.804034, -0.629813, 0.27346, -0.319864, -0.571563, 0.424526, 0.748168, -0.0647249, 0.281479, 0.182639]],
      [[0.167855, -0.112016, -1.62077, -0.261666, -0.0764917, 1.87952, 0.754842, -1.21906, 2.0675, 0.507485, -1.62982, -0.322844],
       [0.112545, -1.39225, 1.39298, -0.955316, 2.15376, -0.263284, 1.55763, 0.607903, 0.349781, -0.0071422, 0.350422, 0.134136],
       [1.03549, -0.501723, 0.985131, 0.684676, -0.68818, 0.46515, 2.41397, -0.606411, 0.888118, -0.29477, 1.15603, 0.225295],
       [-0.481086, 0.0335888, 0.553817, -2.0249, 1.3917, 2.48802, 1.19227, 0.0423679, 3.14216, -0.498194, 1.5271, -0.142932],
       [-0.352369, 2.03124, -1.17303, 0.696517, -1.22949, 0.887501, -0.3622, -0.30882, -0.263226, 0.971151, 0.310887, -1.20696],
       [-0.133801, 0.397475, 0.664568, -0.73024, -1.63277, 0.0749346, 1.80629, 0.402802, -2.04522, -0.556025, 0.596141, 1.0096],
       [-0.0608863, 1.39749, -1.52156, 2.0613, 0.792959, 1.72121, 1.05228, -0.130088, 0.803839, 0.755009, 1.56783, -1.30438],
       [-0.211326, 0.667028, -0.529412, -0.609084, 0.135934, -0.696584, 0.223339, -0.408434, -0.436451, 1.05742, -0.718295, -1.61914],
       [1.16598, 1.70669, -0.498719, 1.52154, 1.31777, 0.399399, -0.85914, 0.90634, -0.921215, -0.844697, 0.154325, 1.71112],
       [-0.674197, 1.19733, -0.840835, -0.837067, 1.00711, -1.72752, 0.0903018, -0.486984, 0.311913, -0.487203, -0.661153, 2.0686]]]])
  inp.requires_grad_()
  w = impl.Tensor(
    [[[[-0.724021, 0.641449, -2.49065, 0.211301, 0.392132],
       [0.190817, 0.553852, 0.438353, 0.90388, 0.798365],
       [0.590415, -0.366289, -0.0265132, -0.00514857, 0.30698],
       [1.35672, -1.40165, -0.838515, -0.0628395, -0.000570761]],
      [[-2.61884, 0.417195, -1.85759, -1.24378, 0.162413],
       [0.964723, 0.643787, 1.03867, 0.825079, -1.14526],
       [-1.66439, -1.61314, 0.372913, -0.870174, -2.08371],
       [-1.22447, 1.06951, 0.631671, 0.214312, 2.04733]],
      [[0.533524, 0.105425, 0.895884, 0.432296, 0.858633],
       [1.60044, -0.0268229, 0.0403271, 0.236713, 0.581645],
       [0.0467834, -0.745889, 0.31962, -1.82933, 0.234949],
       [0.166441, -1.01182, -1.27779, 0.567599, 0.910983]]],
     [[[-1.53552, -0.994475, -0.465683, 0.185439, -0.42384],
       [0.352088, 0.791861, -1.9956, -0.2318, -1.70545],
       [-0.033337, 0.297387, -0.0345254, -1.63702, -0.478121],
       [-0.354293, 0.107615, 0.129975, -0.428731, -0.740729]],
      [[-0.527116, 1.02945, 0.301965, -1.72221, -0.622869],
       [-0.0933961, -1.50927, -0.215147, 0.336273, 0.192545],
       [0.635351, 0.449674, -1.11651, -0.199077, -0.175443],
       [0.922151, 1.47126, -0.309221, -1.38674, 1.4249]],
      [[1.88589, -0.0338851, 1.00106, 1.4482, -0.224235],
       [-1.45907, 0.46854, 0.299053, -1.79179, -0.620932],
       [-0.167815, 0.21093, -0.379566, 0.894621, 1.10281],
       [0.240378, -1.16738, 2.15608, -1.53528, -0.657122]]]])
  w.requires_grad_()
  if impl.__name__ == "torch":
    inp_unf = torch.nn.functional.unfold(inp, (4, 5))
    out_unf = inp_unf.transpose(1, 2).matmul(w.view(w.size(0), -1).t()).transpose(1, 2)
  else:
    inp_unf = inp.unfold([4, 5])
    out_unf = inp_unf.transpose(1, 2).matmul(w.view([w.shape[0], -1]).transpose(-1, -2)).transpose(1, 2)
  
  out_unf.backward(impl.ones_like(out_unf))
  
  return out_unf, inp.grad, w.grad

def testsets_part7():
  print_separate_line()
  print("Testing Part7 Unfold...")
  unfold()
  unfold_hard()
  
if __name__ == "__main__":
  set_debug_mode(True)
  testsets_part7()
  grader_summary("part7")